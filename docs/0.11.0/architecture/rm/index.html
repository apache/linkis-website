<!doctype html>
<html class="docs-version-0.11.0" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Linkis Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Linkis Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache Linkis" href="/opensearch.xml"><title data-react-helmet="true">RM design | Apache Linkis</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://linkis.incubator.apache.org/docs/0.11.0/architecture/rm"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="0.11.0"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-0.11.0"><meta data-react-helmet="true" property="og:title" content="RM design | Apache Linkis"><meta data-react-helmet="true" name="description" content="1 Background"><meta data-react-helmet="true" property="og:description" content="1 Background"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://linkis.incubator.apache.org/docs/0.11.0/architecture/rm"><link data-react-helmet="true" rel="alternate" href="https://linkis.incubator.apache.org/docs/0.11.0/architecture/rm" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://linkis.incubator.apache.org/zh-CN/docs/0.11.0/architecture/rm" hreflang="zh-CN"><link data-react-helmet="true" rel="alternate" href="https://linkis.incubator.apache.org/docs/0.11.0/architecture/rm" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://AE29KQB3IA-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.192d006d.css">
<link rel="preload" href="/assets/js/runtime~main.289353f1.js" as="script">
<link rel="preload" href="/assets/js/main.3d4e593f.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Apache Linkis Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/img/logo.png" alt="Apache Linkis Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Apache Linkis(Incubating)</b></a><a class="navbar__item navbar__link" href="/">Home</a><a class="navbar__item navbar__link" href="/faq/main">FAQ</a><a class="navbar__item navbar__link" href="/download/main">Download</a><a class="navbar__item navbar__link" href="/community/how-to-subscribe">Community</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/team">Team</a><a class="navbar__item navbar__link" href="/user">Users</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/0.11.0/introduction">0.11.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/1.1.2/introduction">Next</a></li><li><a class="dropdown__link" href="/docs/latest/introduction">1.1.1</a></li><li><a class="dropdown__link" href="/docs/1.1.0/introduction">1.1.0</a></li><li><a class="dropdown__link" href="/docs/1.0.3/introduction">1.0.3</a></li><li><a class="dropdown__link" href="/docs/1.0.2/introduction">1.0.2</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/0.11.0/architecture/rm">0.11.0</a></li><li><a class="dropdown__link" href="/versions">All versions</a></li></ul></div><a href="https://github.com/apache/incubator-linkis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg t="1631348384596" class="iconLanguage_EbrZ" viewBox="0 0 1024 1024" version="1.1" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/0.11.0/architecture/rm" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/zh-CN/docs/0.11.0/architecture/rm" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">简体中文</a></li></ul></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button class="clean-btn backToTopButton_i9tI" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh menuWithAnnouncementBar_+O1J"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/docs/0.11.0/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Deployment</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">User Guide</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Engine Usage</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">API Docs</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Architecture</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.11.0/architecture/overview">Overview</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/0.11.0/architecture/rm">RM design</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.11.0/architecture/websocket">WebSocket Request</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Commons</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Storage</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">UJES</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Development Doc</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Upgrade Guide</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->Apache Linkis<!-- --> <b>0.11.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/latest/introduction">latest version</a></b> (<!-- -->1.1.1<!-- -->).</div></div><div class="docItemContainer_oiyr"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->0.11.0</span><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RM design</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="1-background"></a>1 Background<a class="hash-link" href="#1-background" title="Direct link to heading">#</a></h2><p>  In the microservice scenario, the resources consumed and occupied by various services are diverse and more difficult to manage than traditional applications. Linkis RM provides services for the uniform allocation and recycling of resources. When a large number of services are started and closed at a high frequency, it ensures that the consumption of resources by the service does not exceed the limit.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="2-product-design"></a>2 Product Design<a class="hash-link" href="#2-product-design" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="21-overall-architecture-diagram"></a>2.1 Overall architecture diagram<a class="hash-link" href="#21-overall-architecture-diagram" title="Direct link to heading">#</a></h3><p><img alt="RM Architecture Diagram" src="/assets/images/rm_architecture_diagram-1c3dbd483ada630bcfe271fdc26a4b5d.png"></p><p>  RM maintains the available resource information reported by the engine manager, processes the resource application submitted by the engine, and records the actual resource usage information after the successful application.</p><ol><li><p>Engine Manager, EM for short: a microservice that processes requests to start an engine. As a resource provider, EM is responsible for registering and unregistering resources with RM. At the same time, EM, as the manager of the engine, is responsible for applying for resources from RM instead of the engine. For each EM instance, there is a corresponding resource record in the RM, which contains information such as the total resources and protection resources it provides, and dynamically updates the used resources.</p></li><li><p>Engine, also known as application: a microservice that executes user operations. At the same time, as the actual user of resources, the engine is responsible for reporting the actual used resources and releasing resources to the RM. Each Engine has a corresponding resource record in the RM: during the startup process, it is reflected as a locked resource; during the running process, it is reflected as a used resource; after being terminated, the resource record is subsequently deleted.</p></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="22-database-table-structure-design"></a>2.2 Database table structure design<a class="hash-link" href="#22-database-table-structure-design" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">User resource record table:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">linkis_user_resource_meta_data:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">id</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">user</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ticket_id</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">creator</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">em_application_name</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">em_instance</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">engine_application_name</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">engine_instance</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">user_locked_resource: store json directly</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">user_used_resource: json</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">resource_type</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">locked_time</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">used_time</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Module resource record table:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">linkis_em_resource_meta_data:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">id</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">em_application_name</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">em_instance</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">total_resource:json</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">protected_resource:json</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">resource_policy</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">used_resource:json</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">left_resource:json</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">locked_resource:json</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">register_time: long</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Module policy table:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">linkis_em_meta_data:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">id</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">em_name</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">resource_request_policy</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Lock: The table needs to add unique constraint: (scope, user, module_application_name, module_instance) to ensure that the lock is not forced to be acquired multiple times at the same time.</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">linkis_resource_lock:</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">id</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">user</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">em_application_name</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">em_instance</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_y2LR" id="23-types-and-formats-of-resources"></a>2.3 Types and formats of resources<a class="hash-link" href="#23-types-and-formats-of-resources" title="Direct link to heading">#</a></h3><p>  As shown in the figure above, all resource classes implement a top-level Resource interface, which defines the calculation and comparison methods that all resource classes need to support, and performs corresponding mathematical operator overloading, so that resources can be Directly calculated and compared like numbers.</p><table><thead><tr><th align="left">operator</th><th align="left">corresponding method</th><th align="left">operator</th><th align="left">corresponding method</th></tr></thead><tbody><tr><td align="left">+</td><td align="left">add</td><td align="left">&gt;</td><td align="left">moreThan</td></tr><tr><td align="left">-</td><td align="left">minus</td><td align="left">&lt;</td><td align="left">lessThan</td></tr><tr><td align="left">*</td><td align="left">multiply</td><td align="left">=</td><td align="left">equals</td></tr><tr><td align="left">/</td><td align="left">divide</td><td align="left">&gt;=</td><td align="left">notLessThan</td></tr><tr><td align="left">&lt;=</td><td align="left">notMoreThan</td><td align="left"></td><td align="left"></td></tr></tbody></table><p>  The currently supported resource types are shown in the following table. All resources have corresponding json serialization and deserialization methods, which can be stored in json format and transmitted across the network:</p><table><thead><tr><th align="left">Resource Type</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">MemoryResource</td><td align="left">MemoryResource</td></tr><tr><td align="left">CPUResource</td><td align="left">CPU Resource</td></tr><tr><td align="left">LoadResource</td><td align="left">Have both memory and CPU resources</td></tr><tr><td align="left">YarnResource</td><td align="left">Yarn queue resources (queue, queue memory, queue CPU, number of queue instances)</td></tr><tr><td align="left">LoadInstanceResource</td><td align="left">Server resources (memory, CPU, number of instances)</td></tr><tr><td align="left">DriverAndYarnResource</td><td align="left">Driver and actuator resources (both server resources and Yarn queue resources)</td></tr><tr><td align="left">SpecialResource</td><td align="left">Other custom resources</td></tr></tbody></table><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="3-record-the-available-resources-reported-by-em"></a>3 Record the available resources reported by EM<a class="hash-link" href="#3-record-the-available-resources-reported-by-em" title="Direct link to heading">#</a></h2><ol><li><p>When the EM holding the resource starts, it will call the register interface through RPC and pass in the resource in json format for resource registration. The parameters that need to be provided to the register interface are as follows:</p><p>1) Total resources: the total number of resources that the EM can provide.</p><p>2) Protect resources: When the remaining resources are less than this resource, no further resources are allowed to be allocated.</p><p>3) Resource type: such as LoadResource, DriverAndYarnResource and other type names.</p><p>4) EM name: The EM name that provides resources such as sparkEngineManager.</p><p>5) EM instance: machine name plus port name.</p></li><li><p>After the RM receives the resource registration request, it adds a new record to the table linkis_module_resource_meta_data, the content of which is consistent with the parameter information of the interface.</p></li><li><p>When the EM holding the resource is closed, it will call the unregister interface through RPC and pass in its own EM instance information as a parameter to offline the resource.</p></li><li><p>After receiving the resource offline request, the RM finds the row corresponding to the EM instance information in the linkis_module_resource_meta_data table and deletes it; at the same time, finds all the rows corresponding to the EM instance in the linkis_user_resource_meta_data table and deletes it.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="4-resource-allocation-and-recycling"></a>4 Resource allocation and recycling<a class="hash-link" href="#4-resource-allocation-and-recycling" title="Direct link to heading">#</a></h2><ol><li><p>Receive user&#x27;s resource application.</p><p>a) RM provides requestResource interface to EM to report resource application, this interface accepts EM instance, user, Creator and Resource object as parameters. requestResource accepts an optional time parameter. When the processing event exceeds the limit of the time parameter, the resource request will be automatically processed as a failure.</p></li><li><p>Determine whether there are sufficient resources.</p><p>a) According to the EM instance information, find the resource type provided by the EM, and then find the corresponding RequestResourceService (there are multiple subclasses, and each subclass corresponds to one or more resource types and has its own processing logic).</p><p>b) RequestResourceService counts the remaining available resources from multiple dimensions.</p><p> <!-- --> <!-- -->i. According to the total resources of the EM, after subtracting the used resources and the protected resources, the remaining EM available resources are obtained.</p><p> <!-- --> <!-- -->ii. According to the upper limit of the resources allowed by the creator, after subtracting the resources already used by the creator, the remaining available resources of the creator are obtained.</p><p> <!-- --> <!-- -->iii. According to the upper limit of the resources allowed by the user, after subtracting the resources used by the user, the remaining resources available to the user are obtained.</p><p> <!-- --> <!-- -->iv. According to the user&#x27;s global upper limit of the number of instances, subtract the number of engines that the user has started to obtain the remaining number of available instances.</p><p>c) Step by step, compare the remaining available quantity with the requested resources.</p><p> <!-- --> <!-- -->i. According to the order listed in b, once the remaining available quantity of a certain step is less than the quantity applied for, it is immediately determined that there are not enough resources, and NotEnoughResource and the corresponding prompt information are returned, and the determination of subsequent steps will not be performed.</p><p> <!-- --> <!-- -->ii. In the above steps, if the remaining available quantity is greater than the requested quantity until the end, it is determined that there are enough resources, and the next step is to lock the resources.</p></li><li><p>Lock the resource for the request that successfully applied for the resource. After confirming that the resources are sufficient, lock the resources in advance for the application and generate a unique identifier.</p><p>a) In order to ensure the correctness in the concurrent scenario, two locks need to be added before the lock operation (the specific implementation of the lock mechanism is described in another chapter): EM lock and user lock.</p><p> <!-- --> <!-- -->i. EM lock. After the lock is obtained, other resource operations for the EM will not be allowed.</p><p> <!-- --> <!-- -->ii. User lock. After the lock is obtained, other resource operations of the user will not be allowed.</p><p>b) After the two locks are successfully obtained, the judgment will be repeated again to determine whether the resources are sufficient, and if it is still sufficient, continue with the subsequent steps.</p><p>c) Generate a UUID for the resource application, and insert a user resource record in the linkis_user_resource_meta_data table (pre_used_resource is the number of resources requested, and used_resource is null).</p><p>d) Update the corresponding EM resource record fields (locked_resource, left_resource) in the linkis_module_resource_meta_data table.</p><p>e) Submit a timed task. If the task is not cancelled, the two steps c and d will be rolled back after a fixed time, and the UUID will be invalidated so that the locked resources that are not actually used will not be occupied indefinitely.</p><p>f) Return the UUID to the resource applicant.</p><p>g) No matter what happens in the above steps, release the two locks obtained in a at the end.</p></li><li><p>Receive the actual used resources reported by the user.</p><p>a) Provide resourceInited interface, accept UUID, user name, EM instance information, actual use of Resource object and engine instance information as parameters.</p><p>b) After receiving the reported information, obtain the EM lock and user lock.</p><p>c) According to the UUID query to find the corresponding locked resource record, update pre_used_resource to null, and fill in used_resource with the resource actually used.</p><p>d) Update the corresponding module resource record (restore locked_resource, add used_resource).</p><p>e) Abnormal situation: If the corresponding UUID cannot be found, it is considered that the lock on the resource has been lost, and an exception message is returned.</p></li><li><p>Receive a request from the user to release resources.</p><p>a) Provide resourceReleased interface, accept UUID, username, EM instance as parameters.</p><p>b) After receiving the request, obtain the EM lock and the user lock.</p><p>c) Query the corresponding user resource record according to UUID, and delete the row.</p><p>d) Update the corresponding module resource record (clean up used_resource, restore left_resource).</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="5-implementation-of-em-lock-and-user-lock"></a>5 Implementation of EM lock and user lock<a class="hash-link" href="#5-implementation-of-em-lock-and-user-lock" title="Direct link to heading">#</a></h2><p>  The lock is realized through the linkis_resource_lock table, and the unique constraint mechanism of the database itself is used to ensure that the data is not preempted.</p><ol><li><p>EM lock: for the global lock on an instance of an EM operation.</p><p>a) Obtain the lock:</p><p> <!-- --> <!-- -->i. Check whether there is a record where the user is null and the application and instance fields are corresponding values. If there is, it means that the lock has been acquired by other instances, and polling is waiting.</p><p> <!-- --> <!-- -->ii. When there is no corresponding record, insert a record, if the insertion is successful, it means that the lock is successfully obtained; if the insertion encounters a UniqueConstraint error, the record polling and waiting until timeout.</p><p>b) Release the lock:</p><p> <!-- --> <!-- -->i. Delete the record that you own.</p></li><li><p>User lock: lock the operation of a certain EM for a certain user.</p><p>a) Obtain the lock:</p><p> <!-- --> <!-- -->i. Check whether there is a record with the user, application and instance fields as corresponding values. If so, it means that the lock has been acquired by other instances, and wait for polling.</p><p> <!-- --> <!-- -->ii. When there is no corresponding record, insert a record, if the insertion is successful, it means that the lock is successfully obtained; if the insertion fails, the record polling waits until timeout.</p><p>b) Release the lock:</p><p> <!-- --> <!-- -->i. Delete the records held by yourself.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="6-rm-client"></a>6 RM Client<a class="hash-link" href="#6-rm-client" title="Direct link to heading">#</a></h2><p>  In the form of a jar package, the client is provided to resource users and resource providers, including the following:</p><ol><li><p>All resources
Type of Java class (a subclass of Resource class), and the corresponding json serialization method.</p></li><li><p>The Java class (subclass of ResultResource class) of all resource allocation results, and the corresponding json serialization method.</p></li><li><p>The encapsulated RM interface (resource registration, offline, application, available resources and resource release requests).</p><p>After calling the client&#x27;s interface, the client will generate the corresponding RPC command and pass it to a microservice of RM for processing through the Sender. After RM is processed, the result is also returned to the client via RPC.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_y2LR" id="7-multi-instance-state-synchronization"></a>7 Multi-instance state synchronization<a class="hash-link" href="#7-multi-instance-state-synchronization" title="Direct link to heading">#</a></h2><p> <!-- --> <!-- -->Because RM is a key underlying service, in order to prevent the resource allocation of all services from being affected by an abnormality of an RM instance, it is necessary to ensure that multiple RM instances are in service at the same time, and to ensure that a request is received by which instance Processing can ensure the consistency of the results.</p><p> <!-- --> <!-- --> When a user requests the service of RM, he must request it through the forwarding of the gateway service, and cannot directly request a fixed RM instance. Through the service registration and discovery mechanism, the gateway service identifies the RM instance that normally provides the service, and then forwards the RPC request to one of the instances. This ensures that all requests will be processed by the RM instance in the normal state.</p><p>All resource records of <!-- --> <!-- --> <!-- -->RM are stored in the same database, and all RM instances do not maintain their own state. When RM processes a request, any state change involved will obtain state information from the database in real time after the lock is locked, and immediately update the state back to the database after completing the processing logic, and then release the lock. This ensures that when multiple RMs process requests at the same time, they can always be based on the latest status.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/incubator-linkis-website/edit/dev/versioned_docs/version-0.11.0/architecture/rm.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/0.11.0/architecture/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/0.11.0/architecture/websocket"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">WebSocket Request<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-background" class="table-of-contents__link">1 Background</a></li><li><a href="#2-product-design" class="table-of-contents__link">2 Product Design</a><ul><li><a href="#21-overall-architecture-diagram" class="table-of-contents__link">2.1 Overall architecture diagram</a></li><li><a href="#22-database-table-structure-design" class="table-of-contents__link">2.2 Database table structure design</a></li><li><a href="#23-types-and-formats-of-resources" class="table-of-contents__link">2.3 Types and formats of resources</a></li></ul></li><li><a href="#3-record-the-available-resources-reported-by-em" class="table-of-contents__link">3 Record the available resources reported by EM</a></li><li><a href="#4-resource-allocation-and-recycling" class="table-of-contents__link">4 Resource allocation and recycling</a></li><li><a href="#5-implementation-of-em-lock-and-user-lock" class="table-of-contents__link">5 Implementation of EM lock and user lock</a></li><li><a href="#6-rm-client" class="table-of-contents__link">6 RM Client</a></li><li><a href="#7-multi-instance-state-synchronization" class="table-of-contents__link">7 Multi-instance state synchronization</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Linkis</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/latest/introduction">Document</a></li><li class="footer__item"><a class="footer__link-item" href="/faq/main">FAQ</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-linkis/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Releases<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/incubator-linkis" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-linkis/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-linkis/pulls" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Pull Requests<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Subscribe Mailing List</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/community/how-to-subscribe">How to Subscribe</a></li><li class="footer__item"><a href="mailto:dev-subscribe@linkis.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Subscribe Mail<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@linkis.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Mail Archive<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div><img style="height:50px" alt="Apache Software Foundation" src="/img/incubator-logo.svg"><p style="color: #999999;  padding: 0 20px 30px;font-weight:400;text-align:left">Apache Linkis is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p><p></p>
             <p style="padding: 0 20px 30px;color: #999999;font-weight: 400;"> Copyright © 2022 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache Linkis, Apache Incubator, Apache, the Apache feather logo, the Apache Linkis logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
             <div></div></div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.289353f1.js"></script>
<script src="/assets/js/main.3d4e593f.js"></script>
</body>
</html>